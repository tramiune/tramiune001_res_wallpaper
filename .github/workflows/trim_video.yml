<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trim Video (GitHub Actions)</title>
  <style>
    :root{--bd:#e7e7e7;--mut:#666}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{padding:8px 10px;border:1px solid var(--bd);border-radius:10px}
    button{padding:8px 10px;border:1px solid var(--bd);background:#fff;border-radius:10px;cursor:pointer}
    button:hover{background:#f5f5f5}
    .mut{color:var(--mut);font-size:12px;white-space:pre-wrap}
    .k{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .card{border:1px solid var(--bd);border-radius:14px;padding:12px;max-width:820px}
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <b>Trim MP4 & Replace (server-side via GitHub Actions)</b>
      <a class="k" href="./browser.html">‚Üê back</a>
    </div>
    <p class="mut">
- Kh√¥ng c√≤n l·ªói bad memory (kh√¥ng trim trong browser)
- Runner s·∫Ω ch·∫°y ffmpeg r·ªìi commit ƒë√® file mp4 c≈©
- B·∫°n xem progress trong tab Actions c·ªßa repo
    </p>

    <div class="row">
      <input id="token" type="password" placeholder="GitHub Token (workflow + contents write)" style="min-width:320px"/>
      <label class="mut"><input id="remember" type="checkbox"/> remember token</label>
    </div>

    <hr style="border:none;border-top:1px solid var(--bd);margin:12px 0"/>

    <div class="row">
      <input id="folder" placeholder="folder (vd: 101_anime)" style="min-width:220px"/>
      <input id="file" placeholder="file (vd: anime_001.mp4)" style="min-width:220px"/>
    </div>

    <div class="row" style="margin-top:10px">
      <input id="start" type="number" step="0.1" min="0" placeholder="start (sec)" />
      <input id="end" type="number" step="0.1" min="0" placeholder="end (sec)" />
      <select id="mode">
        <option value="FAST">FAST (copy stream)</option>
        <option value="PRECISE">PRECISE (re-encode video)</option>
      </select>
      <input id="crf" type="number" step="1" min="16" max="35" value="23" title="CRF (only PRECISE)"/>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="go">üöÄ Dispatch trim job</button>
      <button id="fillFromQuery">‚Ü∫ Fill from URL query</button>
    </div>

    <div class="mut" id="status" style="margin-top:10px"></div>
  </div>

<script>
  const OWNER="tramiune";
  const REPO="tramiune001_res_wallpaper";
  const BRANCH="main";
  const WORKFLOW_FILE="trim_video.yml"; // must match .github/workflows/trim_video.yml

  const tokenEl=document.getElementById("token");
  const rememberEl=document.getElementById("remember");
  const statusEl=document.getElementById("status");

  const folderEl=document.getElementById("folder");
  const fileEl=document.getElementById("file");
  const startEl=document.getElementById("start");
  const endEl=document.getElementById("end");
  const modeEl=document.getElementById("mode");
  const crfEl=document.getElementById("crf");

  function setStatus(s){ statusEl.textContent=s||""; }
  function qs(){ return new URLSearchParams(location.search); }

  // share token with browser.html (same key)
  const LS_KEY=`wallpaper_browser_token_${OWNER}_${REPO}`;
  (function initToken(){
    const saved=localStorage.getItem(LS_KEY);
    if(saved){ tokenEl.value=saved; rememberEl.checked=true; }
    rememberEl.addEventListener("change",()=>{
      if(rememberEl.checked){
        if(tokenEl.value.trim()) localStorage.setItem(LS_KEY, tokenEl.value.trim());
      } else localStorage.removeItem(LS_KEY);
    });
    tokenEl.addEventListener("input",()=>{
      if(rememberEl.checked) localStorage.setItem(LS_KEY, tokenEl.value.trim());
    });
  })();

  function getToken(){
    const t=(tokenEl.value||"").trim();
    if(!t) throw new Error("Ch∆∞a nh·∫≠p token.");
    return t;
  }

  async function dispatchWorkflow(inputs){
    const token=getToken();
    const url=`https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${encodeURIComponent(WORKFLOW_FILE)}/dispatches`;

    const res=await fetch(url,{
      method:"POST",
      headers:{
        "Authorization":`Bearer ${token}`,
        "Accept":"application/vnd.github+json",
        "Content-Type":"application/json"
      },
      body: JSON.stringify({ ref: BRANCH, inputs })
    });

    if(!res.ok){
      const txt=await res.text().catch(()=> "");
      throw new Error(`Dispatch failed: HTTP ${res.status}\n${txt}`);
    }
  }

  document.getElementById("fillFromQuery").onclick=()=>{
    const p=qs();
    if(p.get("folder")) folderEl.value=p.get("folder");
    if(p.get("video")) fileEl.value=p.get("video");
    setStatus("Filled from query (folder/video).");
  };

  document.getElementById("go").onclick=async()=>{
    try{
      const folder=folderEl.value.trim();
      const file=fileEl.value.trim();
      const start=String(Number(startEl.value||0));
      const end=String(Number(endEl.value||0));
      const mode=modeEl.value;
      const crf=String(Number(crfEl.value||23));

      if(!folder || !file) throw new Error("Thi·∫øu folder/file.");
      if(!(Number(end) > Number(start))) throw new Error("end ph·∫£i > start.");

      setStatus("Dispatching workflow...\nXong b·∫°n v√†o tab Actions c·ªßa repo ƒë·ªÉ xem ti·∫øn tr√¨nh.\nKhi job done, file mp4 s·∫Ω ƒë∆∞·ª£c commit ƒë√®.");

      await dispatchWorkflow({ folder, file, start, end, mode, crf });

      setStatus(
        "‚úÖ Dispatched!\n" +
        `folder=${folder}\nfile=${file}\nstart=${start}\nend=${end}\nmode=${mode}\n\n` +
        "üëâ M·ªü repo > Actions > workflow 'Trim video and replace' ƒë·ªÉ xem log.\n" +
        "üëâ Khi runner push xong, reload browser.html l√† th·∫•y video m·ªõi."
      );
    } catch(e){
      alert(String(e?.message || e));
    }
  };
</script>
</body>
</html>
