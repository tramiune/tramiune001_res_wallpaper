name: Trim MP4 in repo

on:
  workflow_dispatch:
    inputs:
      folder:
        description: "Folder inside resources (e.g. 101_anime)"
        required: true
        type: string
      video:
        description: "Video file name (e.g. anime_003.mp4)"
        required: true
        type: string
      start:
        description: "Start seconds (e.g. 1.2)"
        required: true
        type: string
      end:
        description: "End seconds (e.g. 7.8)"
        required: true
        type: string
      mode:
        description: "FAST=stream copy, PRECISE=re-encode"
        required: false
        default: "FAST"
        type: choice
        options: [FAST, PRECISE]

jobs:
  trim:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Trim
        run: |
          set -e
          FOLDER="${{ inputs.folder }}"
          VIDEO="${{ inputs.video }}"
          START="${{ inputs.start }}"
          END="${{ inputs.end }}"
          MODE="${{ inputs.mode }}"

          IN="resources/$FOLDER/$VIDEO"
          OUT="resources/$FOLDER/$VIDEO.trim.mp4"

          if [ ! -f "$IN" ]; then
            echo "Input not found: $IN"
            exit 1
          fi

          DUR=$(python3 - << 'PY'
import os
s=float(os.environ["START"])
e=float(os.environ["END"])
print(max(0.0, e-s))
PY
)
          if [ "$(python3 - << 'PY'
import os
print(1 if float(os.environ["DUR"])>0 else 0)
PY
)" != "1" ]; then
            echo "Invalid duration"
            exit 1
          fi

          echo "Trimming $IN  start=$START end=$END dur=$DUR mode=$MODE"

          if [ "$MODE" = "FAST" ]; then
            ffmpeg -y -ss "$START" -i "$IN" -t "$DUR" -c copy -avoid_negative_ts make_zero -movflags +faststart "$OUT"
          else
            ffmpeg -y -ss "$START" -i "$IN" -t "$DUR" -c:v libx264 -preset veryfast -crf 23 -c:a aac -b:a 128k -movflags +faststart "$OUT"
          fi

          mv "$OUT" "$IN"

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Trim ${{ inputs.folder }}/${{ inputs.video }} (${{ inputs.start }}-${{ inputs.end }})" || exit 0
          git push
