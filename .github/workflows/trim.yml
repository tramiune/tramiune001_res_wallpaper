name: Trim MP4 in repo

on:
  workflow_dispatch:
    inputs:
      folder:
        description: "Folder inside resources (e.g. 101_anime)"
        required: true
        default: "101_anime"
      video:
        description: "Video file name (e.g. anime_003.mp4)"
        required: true
        default: "anime_003.mp4"
      start:
        description: "Start seconds (e.g. 1.2)"
        required: true
        default: "0"
      end:
        description: "End seconds (e.g. 7.8)"
        required: true
        default: "2.0"
      mode:
        description: "FAST=stream copy, PRECISE=re-encode (enter FAST or PRECISE)"
        required: false
        default: "FAST"

permissions:
  contents: write

jobs:
  trim:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3

      - name: Trim
        env:
          FOLDER: ${{ inputs.folder }}
          VIDEO: ${{ inputs.video }}
          START: ${{ inputs.start }}
          END: ${{ inputs.end }}
          MODE: ${{ inputs.mode }}
        run: |
          set -euo pipefail

          IN="resources/$FOLDER/$VIDEO"
          TMP="resources/$FOLDER/$VIDEO.trim.mp4"

          if [ ! -f "$IN" ]; then
            echo "Input not found: $IN"
            exit 1
          fi

          DUR="$(python3 -c 'import os; s=float(os.environ["START"]); e=float(os.environ["END"]); print(e-s)')"

          python3 -c 'import os; d=float(os.environ["DUR"]); assert d>0, f"Invalid duration DUR={d}"' \
            DUR="$DUR"

          echo "Trimming: $IN"
          echo "start=$START end=$END dur=$DUR mode=$MODE"

          if [ "$MODE" = "FAST" ]; then
            ffmpeg -y -ss "$START" -i "$IN" -t "$DUR" -c copy -avoid_negative_ts make_zero -movflags +faststart "$TMP"
          else
            ffmpeg -y -ss "$START" -i "$IN" -t "$DUR" -c:v libx264 -preset veryfast -crf 23 -c:a aac -b:a 128k -movflags +faststart "$TMP"
          fi

          mv "$TMP" "$IN"

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "resources/${{ inputs.folder }}/${{ inputs.video }}"
          git commit -m "Trim ${{ inputs.folder }}/${{ inputs.video }} (${{ inputs.start }}-${{ inputs.end }})" || exit 0
          git push
