name: Trim MP4 in repo

on:
  workflow_dispatch:
    inputs:
      folder:
        description: "Folder inside resources (e.g. 101_anime)"
        required: true
        type: string
      video:
        description: "Video file name (e.g. anime_003.mp4)"
        required: true
        type: string
      start:
        description: "Start seconds (e.g. 1.2)"
        required: true
        type: string
      end:
        description: "End seconds (e.g. 7.8)"
        required: true
        type: string
      mode:
        description: "FAST=stream copy, PRECISE=re-encode"
        required: false
        default: FAST
        type: choice
        options: [FAST, PRECISE]

permissions:
  contents: write

jobs:
  trim:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3

      - name: Trim
        shell: bash
        run: |
          set -euo pipefail

          FOLDER="${{ inputs.folder }}"
          VIDEO="${{ inputs.video }}"
          START="${{ inputs.start }}"
          END="${{ inputs.end }}"
          MODE="${{ inputs.mode }}"

          IN="resources/${FOLDER}/${VIDEO}"
          OUT="resources/${FOLDER}/${VIDEO}.trim.mp4"

          if [ ! -f "$IN" ]; then
            echo "Input not found: $IN"
            exit 1
          fi

          # Compute duration (END-START) and validate
          DUR="$(python3 -c "s=float('$START'); e=float('$END'); d=e-s; print(d if d>0 else 0.0)")"
          echo "Computed DUR=$DUR"

          python3 -c "d=float('$DUR'); import sys; sys.exit(0 if d>0 else 1)" || {
            echo "Invalid range: start=$START end=$END (duration must be > 0)"
            exit 1
          }

          echo "Trimming: $IN start=$START end=$END dur=$DUR mode=$MODE"

          if [ "$MODE" = "FAST" ]; then
            ffmpeg -y -ss "$START" -i "$IN" -t "$DUR" -c copy -avoid_negative_ts make_zero -movflags +faststart "$OUT"
          else
            ffmpeg -y -ss "$START" -i "$IN" -t "$DUR" -c:v libx264 -preset veryfast -crf 23 -c:a aac -b:a 128k -movflags +faststart "$OUT"
          fi

          mv "$OUT" "$IN"

      - name: Commit & push
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Trim ${{ inputs.folder }}/${{ inputs.video }} (${{ inputs.start }}-${{ inputs.end }})" || exit 0
          git push
